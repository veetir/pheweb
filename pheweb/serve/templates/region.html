{% extends "layout.html" %}


{% block in_head %}
<script type="text/javascript">
  window.pheno = {{ pheno|tojson|safe}};
  window.model.tooltip_lztemplate = {{ tooltip_lztemplate|tojson }};
</script>
{# Includes for LocusZoom.js (from CDN) #}
<link href="https://cdn.jsdelivr.net/npm/locuszoom@{{ config.LZJS_VERSION }}/dist/locuszoom.css" rel="stylesheet" type="text/css" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/d3@^5.16.0" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/locuszoom@{{ config.LZJS_VERSION }}/dist/locuszoom.app.min.js" type="text/javascript"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"></script>


<script src="{{ url_for('.static', filename='region.js') }}"></script>
<link  href="{{ url_for('.static', filename='region.css') }}" rel="stylesheet" type="text/css">
<script src="https://cdn.plot.ly/plotly-3.0.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stopword@3.1.5"></script>
<script src="{{ url_for('.static', filename='gwas_catalog.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
<script src="{{ url_for('.static', filename='finngen_catalog.js') }}"></script>
<script src="{{ url_for('.static', filename='finngen_susie.js') }}"></script>
<script type="text/javascript">
  window.endpointsTsvUrl = "{{ url_for('bp.static', filename='endpoints.tsv') }}";
</script>
{% endblock %}


{% block contained %}
<div class="container-fluid">
  {% for key in ['num_cases', 'num_controls', 'num_samples'] %}
  {% if key in pheno %}
    {% if '<' in pheno[key]|string %}
      <div class="alert alert-danger" role="alert"><b>Warning:</b> This phenotype has {{ pheno[key] }} {{ key.replace('num_','') }}.</div>
    {% elif 0 < pheno[key]|int < 200 %}
      <div class="alert alert-danger" role="alert"><b>Warning:</b> This phenotype only has {{ pheno[key] }} {{ key.replace('num_', '') }}.</div>
    {% endif %}
  {% endif %}
  {% endfor %}
  <div class="row">
    <div class="col-xs-12">
      <h1>{% include "region/h1.html" %}</h1>
    </div>
  </div>
  <div class="row">
      <div class="pheno-info col-xs-12">
          {% if 'num_cases' in pheno %}
            <p><b>{{ pheno.num_cases }}</b> cases, <b>{{ pheno.num_controls }}</b> controls.</p>
          {% elif 'num_samples' in pheno %}
            <p><b>{{ pheno.num_samples }}</b> samples</p>
          {% endif %}
          {% if pheno.category %}
            <p>Category: <b>{{ pheno.category}}</b></p>
          {% endif %}
      </div>
  </div>
  <br>
<div class="row">
  <div class="col-xs-12">
    <div id="lz-1" class="lz-container-responsive" data-region={{ region }}></div>
  </div>
</div>

<div class="row">
  <div class="col-xs-12">
    <div id="susie-header">
      <!-- FinnGen logo -->
      <a href="https://www.finngen.fi/en" target="_blank">
        <img src="{{ url_for('bp.static', filename='images/finngen.png') }}"
              alt="FinnGen Logo" class="finngen-logo">
      </a>
      <!-- Title -->
      <h3>SuSiE</h3>
    </div>
  </div>
</div>

<div id="susie-controls">
  <label>
    <input type="checkbox" id="show-endpoints" checked>
    Endpoints
  </label>
  <label>
    <input type="checkbox" id="show-endpoint-codes">
    Endpoint codes
  </label>
  <label>
    <input type="checkbox" id="show-drugs" checked>
    Drugs
  </label>
  <label>
    <input type="checkbox" id="show-atc-codes">
    ATC codes
  </label>
  <label>
    <input type="checkbox" id="show-low-quality">
    Low-quality CS
      <a href="#" class="info-link"
        title="Toggle credible sets where good_cs is false indicating an unreliable credible set">
        <img src="{{ url_for('bp.static', filename='images/info.svg') }}"
            alt="Info" class="info-icon info-icon-inline icon-invert">
      </a>
    </label>
    <label>
      <input type="checkbox" id="susie-filter-top-in-region" checked>
      Top variants in region
      <a href="#" class="info-link"
        title="When enabled, hides credible set rows whose top variant lies outside the current region window.">
        <img src="{{ url_for('bp.static', filename='images/info.svg') }}"
            alt="Info" class="info-icon info-icon-inline icon-invert">
      </a>
    </label>
    <fieldset class="susie-grouping" id="susie-grouping">
      <legend>Grouping</legend>
      <label>
        <input type="radio" name="susie-grouping" value="identical" id="susie-grouping-identical"> Identical
      </label>
      <label>
        <input type="radio" name="susie-grouping" value="all" id="susie-grouping-all" checked> All
      </label>
      <a href="#" class="info-link"
        title="Choose how credible sets are grouped: Identical keeps only identical intervals together; All combines every credible set into one row.">
        <img src="{{ url_for('bp.static', filename='images/info.svg') }}"
            alt="Info" class="info-icon info-icon-inline icon-invert">
      </a>
    </fieldset>
  </div>

<div id="finngen-susie-wrapper">
  <div id="finngen-susie"></div>
</div>

<div class="row">
  <div class="col-xs-12">
    <div id="gwas-header" class="gwas-flex">
      <p class="gwas-title" title="GWAS catalog last updated {{ gwas_catalog_last_updated or 'unknown' }}">
        <span class="gwas-title-text">GWAS catalog</span>
      </p>
      <div id="gwas-controls" class="gwas-controls">
        <input type="range" id="gwas-year-slider" min="0" max="5" step="1" value="5" list="gwas-year-list">
        <span id="gwas-year-display" class="gwas-year-display">All</span>
        <a href="#" class="info-link"
          title="Filter GWAS Catalog points by date added. Select the earliest year to include. 'All' shows all points."
          aria-label="Filter GWAS Catalog points by date added">
          <span class="info-icon info-icon-inline icon-invert gwas-time-icon" aria-hidden="true">‚è±</span>
        </a>
        <datalist id="gwas-year-list">
          <option value="0" label="1"></option>
          <option value="1" label="2"></option>
          <option value="2" label="3"></option>
          <option value="3" label="5"></option>
          <option value="4" label="10"></option>
          <option value="5" label="All"></option>
        </datalist>
      </div>
    </div>
  </div>
</div>
<div id="plotly-gwas-catalog"></div>

<div id="endpoint-row-wrapper">
  <div id="endpoint-controls-wrapper">
    <div id="finngen-logo-wrapper">
      <a href="https://www.finngen.fi/en" target="_blank">
        <img src="{{ url_for('bp.static', filename='images/finngen.png') }}"
              alt="FinnGen Logo" class="finngen-logo">
      </a>
    </div>
    <div id="endpoint-controls">
      <label for="endpoint-search">
        Search Endpoints
      </label>
      <input type="text" id="endpoint-search" placeholder="Enter a FinnGen endpoint or phenotype..." />
      <label for="endpoint-select" id="endpoint-select-label"></label>
      <select id="endpoint-select"></select>
    </div>
  </div>
  <div id="wordclouds">
    <div id="combined-wordcloud" class="wordcloud-box"></div>
  </div>
</div>

<div id="finngen-gwas-catalog"><p>Select an endpoint to view associations.</p></div>
{% endblock %}
</div>
